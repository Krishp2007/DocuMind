<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DocuMind - Secure Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f3f4f6; }
        .hidden-form { display: none; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-md bg-white rounded-3xl shadow-xl border border-gray-100 p-8 fade-in relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>

        <div class="text-center mb-8 mt-2">
            <div class="inline-flex items-center justify-center w-12 h-12 bg-indigo-50 rounded-xl text-indigo-600 mb-3">
                <i class="fas fa-brain text-2xl"></i>
            </div>
            <h1 class="text-2xl font-bold text-gray-900">DocuMind<span class="text-indigo-600">.ai</span></h1>
            <p class="text-gray-500 text-sm">Enterprise Intelligence Platform</p>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="mb-6 p-3 rounded-lg text-sm font-medium flex items-center gap-2
                        {% if category=='error' %} bg-red-50 text-red-600 border border-red-100 
                        {% else %} bg-green-50 text-green-600 border border-green-100 {% endif %}">
                        <i class="fas {% if category=='error' %}fa-exclamation-circle{% else %}fa-check-circle{% endif %}"></i>
                        <span>{{ message }}</span>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="flex bg-gray-50 p-1 rounded-xl mb-6">
            <button onclick="show('login')" id="tabLogin" class="flex-1 py-2 text-sm font-bold rounded-lg bg-white text-gray-900 shadow-sm transition-all">Log In</button>
            <button onclick="show('register')" id="tabRegister" class="flex-1 py-2 text-sm font-bold rounded-lg text-gray-500 hover:text-gray-700 transition-all">Sign Up</button>
        </div>

        <form id="loginForm" action="/auth/login" method="POST" class="space-y-4">
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Username or Email</label>
                <input type="text" name="username" required class="w-full bg-gray-50 border border-gray-200 rounded-lg px-4 py-3 text-sm focus:bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition-all">
            </div>
            <div>
                <div class="flex justify-between mb-1">
                    <label class="block text-xs font-bold text-gray-500 uppercase">Password</label>
                    <button type="button" onclick="show('forgot')" class="text-xs font-bold text-indigo-600 hover:text-indigo-800">Forgot?</button>
                </div>
                <input type="password" name="password" required class="w-full bg-gray-50 border border-gray-200 rounded-lg px-4 py-3 text-sm focus:bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition-all">
            </div>
            <button class="w-full bg-gray-900 hover:bg-black text-white font-bold py-3 rounded-lg shadow-lg transition-all mt-2">
                Log In
            </button>
        </form>

        <form id="registerForm" action="/auth/register" method="POST" class="space-y-4 hidden-form">
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Full Name</label>
                    <input type="text" name="full_name" required class="w-full bg-gray-50 border border-gray-200 rounded-lg px-4 py-3 text-sm outline-none focus:border-indigo-500">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Username</label>
                    <input type="text" name="username" required class="w-full bg-gray-50 border border-gray-200 rounded-lg px-4 py-3 text-sm outline-none focus:border-indigo-500">
                </div>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Email Address</label>
                <div class="flex gap-2">
                    <input type="email" id="regEmail" name="email" required class="flex-1 bg-gray-50 border border-gray-200 rounded-lg px-4 py-3 text-sm outline-none focus:border-indigo-500">
                    <button type="button" id="btnReg" onclick="sendOtp('register', 'regEmail', 'btnReg')" class="bg-gray-100 text-indigo-600 hover:bg-indigo-50 border border-gray-200 px-4 rounded-lg text-xs font-bold whitespace-nowrap transition-colors">Get Code</button>
                </div>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Password</label>
                <input type="password" name="password" required class="w-full bg-gray-50 border border-gray-200 rounded-lg px-4 py-3 text-sm outline-none focus:border-indigo-500">
            </div>

            <div id="otpSection" class="hidden bg-indigo-50 p-4 rounded-xl border border-indigo-100 text-center fade-in">
                <p class="text-xs text-indigo-800 font-bold mb-2">VERIFICATION CODE</p>
                <input type="text" name="otp" maxlength="6" placeholder="000000" class="w-32 text-center text-lg font-mono font-bold tracking-widest bg-white border border-indigo-200 rounded-lg py-2 outline-none focus:ring-2 focus:ring-indigo-300">
                <button class="w-full mt-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg text-sm shadow-md transition-all">Verify & Register</button>
            </div>
        </form>

        <form id="forgotForm" action="/auth/reset-password" method="POST" class="space-y-4 hidden-form">
            <div class="text-center mb-4">
                <h3 class="text-lg font-bold text-gray-900">Reset Password</h3>
                <p class="text-xs text-gray-500">We'll send a code to your email.</p>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Email Address</label>
                <div class="flex gap-2">
                    <input type="email" id="forgotEmail" name="email" required class="flex-1 bg-gray-50 border border-gray-200 rounded-lg px-4 py-3 text-sm outline-none focus:border-indigo-500">
                    <button type="button" id="btnForgot" onclick="sendOtp('reset', 'forgotEmail', 'btnForgot')" class="bg-gray-100 text-indigo-600 hover:bg-indigo-50 border border-gray-200 px-4 rounded-lg text-xs font-bold whitespace-nowrap transition-colors">Get Code</button>
                </div>
            </div>

            <div id="forgotFields" class="hidden space-y-3 fade-in">
                <div>
                    <input type="text" name="otp" maxlength="6" placeholder="Enter 6-digit Code" class="w-full text-center bg-gray-50 border border-gray-200 rounded-lg px-4 py-3 font-mono tracking-widest outline-none focus:border-indigo-500">
                </div>
                <div>
                    <input type="password" name="new_password" placeholder="New Password" required class="w-full bg-gray-50 border border-gray-200 rounded-lg px-4 py-3 text-sm outline-none focus:border-indigo-500">
                </div>
                <button class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg shadow-lg transition-all">Reset Password</button>
            </div>

            <div class="text-center pt-2">
                <button type="button" onclick="show('login')" class="text-xs font-bold text-gray-400 hover:text-gray-600">Back to Login</button>
            </div>
        </form>

    </div>

    <script>
        function show(tab) {
            ['loginForm', 'registerForm', 'forgotForm'].forEach(id => document.getElementById(id).style.display = 'none');
            
            const tLog = document.getElementById('tabLogin');
            const tReg = document.getElementById('tabRegister');
            
            tLog.className = "flex-1 py-2 text-sm font-bold rounded-lg text-gray-500 hover:text-gray-700 transition-all";
            tReg.className = "flex-1 py-2 text-sm font-bold rounded-lg text-gray-500 hover:text-gray-700 transition-all";

            if(tab === 'login') {
                document.getElementById('loginForm').style.display = 'block';
                tLog.className = "flex-1 py-2 text-sm font-bold rounded-lg bg-white text-indigo-600 shadow-sm transition-all";
            } else if(tab === 'register') {
                document.getElementById('registerForm').style.display = 'block';
                tReg.className = "flex-1 py-2 text-sm font-bold rounded-lg bg-white text-indigo-600 shadow-sm transition-all";
            } else if(tab === 'forgot') {
                // CLEAR FIELDS ON SHOW
                document.getElementById('forgotEmail').value = '';
                document.getElementById('forgotFields').classList.add('hidden');
                document.getElementById('forgotForm').style.display = 'block';
            }
        }

        async function sendOtp(purpose, emailId, btnId) {
            const email = document.getElementById(emailId).value;
            const btn = document.getElementById(btnId);
            
            if(!email.includes('@')) { alert("Enter valid email"); return; }
            
            const oldText = btn.innerText;
            btn.innerText = "...";
            btn.disabled = true;
            
            try {
                const res = await fetch('/api/send-otp', {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({email, purpose})
                });
                const data = await res.json();
                
                if(data.success) {
                    btn.innerText = "Sent âœ“";
                    btn.classList.add('bg-green-100', 'text-green-700');
                    if(purpose === 'register') document.getElementById('otpSection').classList.remove('hidden');
                    else document.getElementById('forgotFields').classList.remove('hidden');
                } else {
                    alert(data.error);
                    btn.innerText = oldText;
                    btn.disabled = false;
                }
            } catch {
                alert("Network error");
                btn.innerText = oldText;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>